# Sample Workflow: Code Implementation with Parallel Review
# Demonstrates all available features: parallel steps, decision routing,
# human gates, and check modes.
#
# Flow: plan → implement → review (parallel) → finalize → end
#       └──────────────────────────┘ (loop on REJECTED)

name: code-implementation

steps:
  plan:
    agent: general-purpose
    prompt: |
      Analyze the task and create an implementation plan.

      Consider:
      - Architecture and design decisions
      - Files that need to be created or modified
      - Potential risks and edge cases
      - Testing strategy

      End with <!-- DECISION: PLANNED --> or <!-- DECISION: BLOCKED -->
    next:
      - if: PLANNED
        goto: implement
      - if: BLOCKED
        goto: plan                    # Retry until unblocked
      - goto: plan                    # Fallback: retry planning

  implement:
    prompt: |
      Implement the task according to the plan in .jdi/reports/{task_id}/plan.md.

      Requirements:
      - Follow project coding standards
      - Write tests for your changes
      - Handle edge cases identified in the plan

      End with <!-- DECISION: DONE --> or <!-- DECISION: ERROR -->
    next:
      - if: DONE
        goto: review
      - if: ERROR
        goto: implement               # Retry on error
      - goto: implement

  # Parallel review: multiple agents review simultaneously
  review:
    parallel:
      - agent: general-purpose
        prompt: |
          Review the implementation in .jdi/reports/{task_id}/implement.md for:
          - Code quality and readability
          - Test coverage and correctness
          - Performance considerations
          - Error handling

          Reference the plan in .jdi/reports/{task_id}/plan.md for context.

          End with <!-- DECISION: APPROVED --> or <!-- DECISION: REJECTED -->
      - agent: general-purpose
        prompt: |
          Review the implementation in .jdi/reports/{task_id}/implement.md for:
          - Security vulnerabilities (OWASP Top 10)
          - Input validation
          - Authentication/authorization issues
          - Data exposure risks

          End with <!-- DECISION: APPROVED --> or <!-- DECISION: REJECTED -->
    check: all                        # All reviewers must approve
    next:
      - if: APPROVED
        goto: finalize
      - if: REJECTED
        goto: implement               # Loop back for fixes
      - goto: implement

  # Human gate: requires --human flag to proceed
  finalize:
    human: true
    prompt: |
      Finalize the implementation:
      - Remove any TODO comments
      - Ensure documentation is complete
      - Verify all tests pass
      - Clean up debug code

      Reference:
      - .jdi/reports/{task_id}/plan.md for original requirements
      - .jdi/reports/{task_id}/implement.md for what was built
      - .jdi/reports/{task_id}/review.md for review feedback
    next:
      - goto: end

# Notes:
# - Entry point: First step (plan) — tasks without step prefix start here
# - Step prefix: Task subject like "[review] Fix bug" indicates current step
# - Reports: Always written to .jdi/reports/{task_id}/{step_name}.md
# - Parallel reports: Merged into single {step_name}.md
# - Decision block: Agents end output with <!-- DECISION: KEYWORD -->
# - Terminal steps: next: [- goto: end] — no decision parsing needed
# - Feedback: On REJECTED, feedback is appended to task description for next iteration
